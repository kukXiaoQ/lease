<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.situ.ws.mapper.NotificationsMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.situ.ws.bean.entries.Notifications">
        <id column="id" property="id" />
        <result column="user_id" property="userId" />
        <result column="message" property="message" />
        <result column="sent_at" property="sentAt" />
        <result column="is_del" property="isDel"/>
    </resultMap>


    <resultMap id="notificationsDtoMap" type="com.situ.ws.bean.dto.NotificationsDto">
        <id column="id" property="id"/>
        <result column="sent_at" property="sentAt"/>
        <result column="email" property="email"/>
    </resultMap>


    <insert id="insert">
        insert into notifications (user_id, message, sent_at)
        values (#{not.userId},#{not.message},#{not.sentAt});
    </insert>


    <!--    逻辑删除-->
    <update id="logicalDeletion" parameterType="long">
        update notifications
        set is_del = 1
        where id in
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
        and `is_del` = 0
    </update>

    <select id="selectPageByNewWhere" resultMap="notificationsDtoMap">
        select notifications.id,notifications.message,notifications.sent_at,users.email,users.nickname,users.username from notifications
           LEFT JOIN users on notifications.user_id = users.id
        <include refid="where"/>
        <if test="page.start != null and page.start >= 0">
            limit #{page.start},#{page.size}
        </if>
    </select>

    <sql id="where">
        <where>
            notifications.is_del = 0
            <if test="dto.username != null and dto.username != ''">
                <bind name="likeUserName" value="'%' + dto.username + '%'"/>
                and users.username like #{likeUserName}
            </if>
            <if test="dto.nickname != null and dto.nickname != ''">
                <bind name="likeNickName" value="'%' + dto.nickname + '%'"/>
                and users.username like #{likeNickName}
            </if>
            <if test="dto.email != null and dto.email != ''">
                <bind name="likeEmail" value="'%' + dto.email + '%'"/>
                and users.email like #{likeEmail}
            </if>
            <if test="dto.sentAt != null">
                and notifications.sent_at &gt;= #{dto.sentAt}
            </if>
        </where>
    </sql>


    <select id="getCount" resultType="java.lang.Integer">
        select count(*) from notifications
        LEFT JOIN users on notifications.user_id = users.id
        <include refid="where"/>
    </select>

</mapper>
